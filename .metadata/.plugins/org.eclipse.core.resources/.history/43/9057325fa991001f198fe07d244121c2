#include "sys_can_receive.h"
#include "main.h"
#include <stdlib.h>
#include <stdbool.h>

static CAN_HandleTypeDef* rx_hcan;
static uint16_t num_params;
static bool ready = false;

void can_rx_init(CAN_HandleTypeDef* hcan, board_param_t* param, uint16_t that_num_params) {
	rx_hcan = hcan;
	num_params = that_num_params;
	ready = true;
}

void can_receive_message(board_param_t* params) {
	if (!ready) return;
	static CAN_RxHeaderTypeDef RxHeader;
	static can_data_t data;
	if (HAL_CAN_GetRxMessage(rx_hcan, CAN_RX_FIFO0, &RxHeader, data.data) != HAL_OK ) return;
	for (int i = 0; i < num_params; i++) {
		if (params[i].ID != data.ID || params[i].type != TO_SEND) continue;
		board_param_t* param = &params[i];
		param->ival = data.ival;
		param->timestamp = HAL_GetTick();
		param->stale = false;
	}
}
